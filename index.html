<html>

<head>
    <title>软件著作权申请时间线解析</title>
    <style>
        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        #result {
            margin-top: 10px;
        }

        table {
            border-collapse: collapse;
            margin: 0 auto;
        }

        tr:hover {
            background-color: black;
            color: white;
        }

        th, td {
            border-top: 1px solid gray;
            border-bottom: 1px solid gray;
            padding: 5px 20px;
        }
    </style>
</head>

<body>
    <div id="main" style="margin: 0 15%">
        <h1 class="text-center">软件著作权申请时间线解析</h1>
        <div>
            <div><button id="parseBtn">从剪贴板导入Key和Token</button></div>
            <div>
                <label class="text-right">账号ID：</label>
                <input type="text" id="accountId">

                <label class="text-right">Authorization_key: </label>
                <input type="text" name="" id="authorizationKey">

                <label class="text-right">Authorization_token: </label>
                <input type="text" name="" id="authorizationToken">
                <button id="flowNumberListBtn">获取申请列表</button>
            </div>

            <div>
                <label class="text-right">软著名称：</label>
                <select id="flowNumberList"></select>
                <button id="timelineBtn">解析申请时间线</button>
            </div>
        </div>
        <div id="result"></div>
    </div>
</body>
<script>
    function formatWithZero(num) {
        return num < 10 ? `0${num}` : num;
    }
    function strftime(str) {
        let dateFromTimestampe = new Date(str);
        let year = dateFromTimestampe.getFullYear();
        let month = formatWithZero(dateFromTimestampe.getMonth() + 1);
        let day = formatWithZero(dateFromTimestampe.getDate());
        let hour = formatWithZero(dateFromTimestampe.getHours());
        let minute = formatWithZero(dateFromTimestampe.getMinutes());
        let second = formatWithZero(dateFromTimestampe.getSeconds());
        return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
    }

    function get(url, callback, requestHeaders) {
        let xhr = new XMLHttpRequest();
        xhr.open("get", url);
        for (var headerName in requestHeaders) {
            xhr.setRequestHeader(headerName, requestHeaders[headerName]);
        }
        xhr.send();
        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                callback(xhr.status, xhr.responseText);
            }
        };
    }
    
    window.onload = function () {
        let oParseBtn = document.getElementById("parseBtn");

        let oAccount = document.getElementById("accountId");
        let oAuthorizationKey = document.getElementById("authorizationKey");
        let oAuthorizationToken = document.getElementById("authorizationToken");

        let oFlowNumberList = document.getElementById("flowNumberList");
        let oFlowNumberListBtn = document.getElementById("flowNumberListBtn");
        let oTimelineBtn = document.getElementById("timelineBtn");
        let oResult = document.getElementById("result");

        oParseBtn.onclick = function() {
            navigator.clipboard.readText().then(text => {
                text = text.trim();
                if (text == "") {
                    return;
                }

                let json = JSON.parse(text);
                if (json.length == 0 || json[0].length == 0) {
                    return;
                }

                let data = json[0][0];
                if (data.hasOwnProperty("key")) {
                    oAuthorizationKey.value = json[0][0]["key"];
                }
                if (data.hasOwnProperty("token")) {
                    oAuthorizationToken.value = json[0][0]["token"];
                }
            }).catch(err => {
                console.error('读取剪切板内容失败：', err);
            });
        };

        oFlowNumberListBtn.onclick = function() {
            let accountId = oAccount.value.trim();
            let authorizationKey = oAuthorizationKey.value.trim();
            let authorizationToken = oAuthorizationToken.value.trim();
            if (accountId == "" || authorizationKey == "" || authorizationToken == "") {
                alert("请填写账号ID、Authorization_key以及Authorization_token等信息");
                return;
            }

            let url = `https://gateway.ccopyright.com.cn/registerQuerySoftServer/userCenter/statusList/${oAccount.value}?keyWord=&applyDate=ALL&status=ALL&applyType=&createUser=${oAccount.value}&pageNum=1&pageSize=10`;
            get(url, 
                function(status, responseText) {
                    let data = JSON.parse(responseText);
                    if (status != 200) {
                        oFlowNumberList.innerHTML = data["msg"];
                        return;
                    }
                    
                    let r = data["data"]["list"]
                    let content;
                    for (var i = 0; i < r.length; i++) {
                        let item = r[i];
                        content += `<option value="${item["flowNumber"]}">${item["softwareFullName"]} [ ${item["showName"]} ]</option>`;
                    }
                    oFlowNumberList.innerHTML = content;
                }, 
                {
                    "Authorization": `Bearer ${oAuthorizationToken.value}`,
                    "Authorization_key": oAuthorizationKey.value,
                    "Authorization_token": oAuthorizationToken.value,
                    "Device": "pc"
                }
            );
        };

        oTimelineBtn.onclick = function () {
            let accountId = oAccount.value.trim();
            let authorizationKey = oAuthorizationKey.value.trim();
            let authorizationToken = oAuthorizationToken.value.trim();
            if (accountId == "" || authorizationKey == "" || authorizationToken == "" || oFlowNumberList.options.length == 0) {
                alert("请填写账号ID、Authorization_key以及Authorization_token等信息");
                return;
            }

            let url = `https://gateway.ccopyright.com.cn/registerQuerySoftServer/userCenter/flowNumberHistory/${accountId}/${oFlowNumberList.options[oFlowNumberList.selectedIndex].value}`;
            get(url, 
                function(status, responseText) {
                    let data = JSON.parse(responseText);
                    if (status != 200) {
                        oResult.innerHTML = data["message"];
                        return;
                    }
                    
                    let r = data["data"]
                    let content = "<table>";
                    content += "<caption class='text-left'><strong>解析结果：</strong></caption>";
                    content += "<tr><th class='text-center'>序号</th>";
                    content += "<th class='text-left'>用户状态</th>";
                    content += "<th class='text-left'>操作状态</th>";
                    content += "<th class='text-left'>时间</th></tr>";
                    for (var i = 0; i < r.length; i++) {
                        let item = r[i];
                        content += `<tr><td class="text-center">${i + 1}</td>`;
                        content += `<td>${item["userStatus"]}</td>`;
                        content += `<td>${item["operateStatus"]}</td>`;
                        content += `<td>${strftime(r[i]["createTime"])}`;
                        if (item["handleOption"] != null) {
                            content += `<br/><small>(${item["handleOption"]})</small>`;
                        }
                        content += "</td></tr>"
                    }
                    content += "</table>";
                    oResult.innerHTML = content;
                }, 
                {
                    "Authorization": `Bearer ${authorizationToken}`,
                    "Authorization_key": authorizationKey,
                    "Authorization_token": authorizationToken,
                    "Device": "pc"
                }
            );
        };
    };
</script>

</html>